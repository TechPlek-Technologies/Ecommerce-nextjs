"use strict";(()=>{var e={};e.id=7185,e.ids=[7185],e.modules={3681:e=>{e.exports=require("custom-id-new")},11185:e=>{e.exports=require("mongoose")},60614:e=>{e.exports=require("next-auth/jwt")},20145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},89346:(e,t,a)=>{a.r(t),a.d(t,{config:()=>h,default:()=>q,routeModule:()=>_});var r={};a.r(r),a.d(r,{config:()=>g,default:()=>apiHandler});var i=a(71802),n=a(47153),s=a(56249);let o=require("async");var d=a(3681),l=a.n(d),u=a(60614),c=a(22403),p=a(10090),m=a(28434),f=a(16572),w=a(13808),y=a(11217);let g={api:{bodyParser:!1}};async function apiHandler(e,t){let{method:a}=e,r=process.env.AUTH_SECRET,i=await (0,u.getToken)({req:e,secret:r});await (0,w.Z)();let decrementQty=async e=>{(0,o.eachSeries)(e,async(e,t)=>{if(e.color.name||e.attribute.name){let a=await m.Z.findById(e._id);if(a){let r=e.color.name,i=e.attribute.name,n=a.variants.find(e=>e.color===r&&e.attr===i);-1!=n.qty&&(n.qty=n.qty-e.qty,a.markModified("variants"),await a.save(t))}}else{let a=await m.Z.findById(e._id);a&&-1!=a.quantity&&(a.quantity=a.quantity-e.qty,await a.save(t))}},e=>{e&&console.log(e)})},getTotalPrice=async e=>{let t=await e.reduce((e,t)=>e+t.qty*t.price,0);return Math.round(10*t)/10},getTotalVat=async e=>{let t=await e.reduce((e,t)=>e+t.qty*t.price*t.vat/100,0);return+t},getTotalTax=async e=>{let t=await e.reduce((e,t)=>e+t.qty*t.price*t.tax/100,0);return+t};if("POST"===a)try{var n;let a=await (0,y.c)(e),{checkoutData:r}=a.field,s=JSON.parse(r),{coupon:o,products:d,billingInfo:u,shippingInfo:m,deliveryInfo:w,paymentData:g}=s;await decrementQty(d);let q=await getTotalPrice(d),h=await getTotalVat(d),_=await getTotalTax(d),v=(n=o.discount,Math.round(10*(n/100*q))/10),x=Math.round((q+h+_+(w.cost||0)-v)*10)/10,P=`R${l()({randomLength:4,upperCase:!0})}`,b="Cash On Delivery"===g.method?"Unpaid":"Paid",T={orderId:P,products:d,status:"Pending",billingInfo:u,shippingInfo:m,deliveryInfo:w,paymentMethod:g.method,paymentStatus:b,paymentId:g.id,totalPrice:q,payAmount:x,coupon:o,vat:h,tax:_},k=await p.Z.create(T);i&&i.user.id&&await f.Z.findByIdAndUpdate(i.user.id,{$push:{orders:k._id}});let M=`<p>A new order (<a href="/dashboard/orders/${k._id}" target="_blank">${k.orderId}</a>) has been placed</p>`;await c.Z.create({message:M}),t.status(200).json({success:!0,createdOrder:k})}catch(e){console.log(e),t.status(500).json({success:!1})}else t.status(400).json({success:!1})}let q=(0,s.l)(r,"default"),h=(0,s.l)(r,"config"),_=new i.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/order/new",pathname:"/api/order/new",bundlePath:"",filename:""},userland:r})},11217:(e,t,a)=>{a.d(t,{c:()=>parseForm,t:()=>parseFormMultiple});let r=require("formidable");var i=a.n(r);function parseForm(e){return new Promise((t,a)=>{let r=i()({keepExtensions:!0,uploadDir:"./public/uploads"});r.parse(e,(e,r,i)=>{if(e)return a(e);t({field:r,file:i})})})}function parseFormMultiple(e){return new Promise((t,a)=>{let r=i()({multiples:!0,keepExtensions:!0,uploadDir:"./public/uploads"});r.parse(e,(e,r,i)=>{if(e)return a(e);t({field:r,file:i})})})}}};var t=require("../../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),a=t.X(0,[4222,9305,3808],()=>__webpack_exec__(89346));module.exports=a})();